# iot4i-shield-toolkit
An IBM streams shield development toolkit which contains a set of operators and helper function that can help quickly develop shields for IBM IoT for insurance service. The toolkit provides the following:

1. source/sink operators that abstract the details of connecting to IBM IoT platform.
2. source/sink operators that abstract the details of connecting to IBM message hub service.
3. CheckActivation operator which can be used to connect with IoT4i API and verify whether the shield is activated or not for a particular user.
4. Transformer operator which annotate the raw sensor events with user information.  
5. Action sink operator which calls IoT4i API to create a hazard and invoke actions.
6. Enforce and validate the hazards generated by shield jobs.

### Structure

This toolkit is divided into two stages:

#### Prepare Events Stage:

This is the stage where the events are prepare for the shield jobs. The following operators are part of this stage:

**Common Operators**:
 
 1. [TransformerOp](./impl/java/src/com/ibm/iot4i/events/common/TransformerOp.java):
 A java primitive operator to annotated raw events with user information. This operator adds also unique eventIds to the raw events. The operator accepts the following input params:
 
 `deviceIdAttributeNames`:  The name of the attribute in the event payload that contains the physical device Id. The operator will check by default the deviceId of the IoTP topic, if not deviceId is found, it will search in the payload based on the attribute name provided here.
 
 The operator requires also `apiURL`, `apiToken`, and `tenantId` but this will be provided by the IoT4i API when the job is submitted.
 
 2. [CheckActivationOp](./impl/java/src/com/ibm/iot4i/events/common/CheckActivationOp.java):
 
 A java primitive operator to check if the user has activated his shield or not. If the user didn't active his shield, the events will be filtered out. The operator requires the following input params:
 
 `apiURL`,  `apiToken`, `shieldId` and `tenantId` which will be all provided by IoT4i APi when the job is submitted.
 
 **IBM IoT Platform Operators**:
 
 1. [Source](./com.ibm.iot4i.events.IoTP/Source.spl)
 
 A source operator that abstract the details of connecting to IBM IoT platform. This operator has no input and generate an output with type `stream<rstring key, rstring message>`. The key contains the IoTP topic and the message contains the payload.

 2. [Transformer](./com.ibm.iot4i.events.IoTP/Transformer.spl)
 
 An operator that receives raw events and transform them using the [TransformerOp](./impl/java/src/com/ibm/iot4i/events/common/TransformerOp.java). The operator refresh the cache of the TransformerOp by listening to operational notifications.
 
 3. [CheckActivation](./com.ibm.iot4i.events.IoTP/CheckActivation.spl)
 
 An operator that receives transformed events and check filter events based on the [CheckActivationOp](./impl/java/src/com/ibm/iot4i/events/common/CheckActivationOp.java).
 
 
 **Message Hub Operators**:
 
  1. [Source](./com.ibm.iot4i.events.IoTP/Source.spl)
  
  A source operator that abstract the details of connecting to IBM Message HUB. This operator has no input and generate an output with type `stream<rstring key, rstring message>`. 
  
  2. [AnnotatedSource](./com.ibm.iot4i.events.MH/AnnotatedSource.spl)
  
  A source operator that listen to the annotated events which are generated by the transformer job. This operator uses the Source operator internally but listens to different topic and make sure the userId is added to the events. 
 
  2. [Transformer](./com.ibm.iot4i.events.MH/Transformer.spl)
  
  An operator that receives raw events and transform them using the [TransformerOp](./impl/java/src/com/ibm/iot4i/events/common/TransformerOp.java). The operator refresh the cache of the TransformerOp by listening to operational notifications.
  
  3. [CheckActivation](./com.ibm.iot4i.events.MH/CheckActivation.spl)
  
  An operator that receives transformed events and check filter events based on the [CheckActivationOp](./impl/java/src/com/ibm/iot4i/events/common/CheckActivationOp.java).
  

#### Submit Hazards Stage

In this stage, the hazard generated by the shield jobs are prepared for submission either to an IoTP sink, MH sink or to an Action sink. 

**Common Operators**:

1. [ActionSink](./com.ibm.iot4i.hazards.common/ActionSink.spl)

An operator that receives hazards and call the create hazard API of IoT4i.

2. [PrepareHazards](./com.ibm.iot4i.hazards.common/PrepareHazards.spl)

An operator that prepare the hazard for all sinks. It parse the hazard to string, adds shieldId and make sure that the userId exists. 

**IBM IoT Platform Operators**:

1. [Sink](./com.ibm.iot4i.hazards.IoTP/Sink.spl)

An operator that receives hazards and publish them to IoTP.

2. [SubmitHazards](./com.ibm.iot4i.hazards.IoTP/SubmitHazards.spl)

An operator that receives hazards, prepare them, then calls the IoTP and Action sinks. 

**Message Hub Operators**:


1. [Sink](./com.ibm.iot4i.hazards.MH/Sink.spl)

An operator that receives hazards and publish them to MH.

2. [SubmitHazards](./com.ibm.iot4i.hazards.MH/SubmitHazards.spl)

An operator that receives hazards, prepare them, then calls the MH sink. 
